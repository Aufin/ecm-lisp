#!/bin/sh
ECM_SCRIPT=$(readlink -f "$0")
ECM_SCRIPT_PATH=$(dirname "$ECM_SCRIPT")
. "$ECM_SCRIPT_PATH/../etc/ecm-conf"

mkdir -p "/tmp/ecm"
PIDFILE="/tmp/ecm/s3-rsync-attachments.pid"

if [ -e "${PIDFILE}" ] && (ps -u $(whoami) -opid= \
| grep -P "^\s*$(cat ${PIDFILE})$" &> /dev/null); then
  echo "Already running."
  exit 99
fi

echo $! > "${PIDFILE}"
chmod 644 "${PIDFILE}"

mkdir -p $ECM_LOG_PATH;
RSYNC_ERRORS=`mktemp`
RSYNC_LOG=$ECM_LOG_PATH/s3-rsync-attachments.log

a_rsync() {
    rsync -T /tmp/rsync -avP  -W --size-only --inplace \
          /mnt/enc/reverse/attachment/ /mnt/s3/ecm-attachment/reverse/
}

email_msg() {
    A_SUBJECT=$1;shift;
    cat - | mail --to $ECM_ADMIN_EMAIL --subject "$A_SUBJECT"
}

do_error() {
 cat $RSYNC_ERRORS | email_msg "ERROR for s3 rsync attachments"
    cat $RSYNC_ERRORS >> $RSYNC_LOG
    cat $RSYNC_ERRORS;
    rm $RSYNC_ERRORS;
    rm $PIDFILE;
    exit 12
}    
  
a_rsync >> $RSYNC_LOG 2> $RSYNC_ERRORS || do_error ;

tail -n 10 $RSYNC_LOG | email_msg "Rsync s3 attachments completed" 
rm $PIDFILE;
