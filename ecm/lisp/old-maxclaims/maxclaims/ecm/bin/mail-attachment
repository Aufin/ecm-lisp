#!/bin/sh
# Absolute path to this script, e.g. /home/user/bin/foo.sh
SCRIPT=$(readlink -f "$0")
# Absolute path this script is in, thus /home/user/bin
SCRIPTPATH=$(dirname "$SCRIPT")
echo $SCRIPTPATH

ECM_ATTACHMENT_DIR=/home/maxclaims/attachment
ECM_ARCHIVE_DIR=/home/maxclaims/archive

# The claim is the first argument
ECM_CLAIM=${1-33342}
echo "Mailing Attachment for Claim #" $ECM_CLAIM

ECM_CLAIM_ATTACHMENT_DIR=$ECM_ATTACHMENT_DIR/$ECM_CLAIM


echo "Importing from" "$ECM_CLAIM_ATTACHMENT_DIR/*.msg" \ "(" \
     $(sh -c "ls -1 $ECM_CLAIM_ATTACHMENT_DIR/*.msg | wc -l")" )" "messages"

mkdir -p /tmp/msgconvert/  
ECM_MSGCONVERT_MBOX=$(mktemp --suffix=.mbox --tmpdir=/tmp/msgconvert)

msgconvert --mbox $ECM_MSGCONVERT_MBOX $ECM_CLAIM_ATTACHMENT_DIR/*.msg 2>1 \
    | sed 's/^Wide characte/asd/'

sed -i 's/FYDIBOHF23SPDLT/Marion Maxwell/g' $ECM_MSGCONVERT_MBOX

ECM_HYPERMAILCONF=$SCRIPTPATH/../etc/hypermail.conf

hypermail -x -u -c $ECM_HYPERMAILCONF \
          -o label="Claim #$ECM_CLAIM" \
          -m $ECM_MSGCONVERT_MBOX \
          -d $ECM_ARCHIVE_DIR/$ECM_CLAIM/list/ \
          -o append_filename=`echo '$DIR/../'$ECM_CLAIM'.mbox'`    
 rm $ECM_MSGCONVERT_MBOX ;
